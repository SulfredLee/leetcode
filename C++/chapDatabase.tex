\chapter{Database}
Database questions
\newline

\section{Combine Two Tables} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:combine-two-tables}


\subsubsection{描述}
SQL Schema

Table: Person
\begin{Code}
+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| PersonId    | int     |
| FirstName   | varchar |
| LastName    | varchar |
+-------------+---------+
PersonId is the primary key column for this table.
\end{Code}

Table: Address
\begin{Code}
+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| AddressId   | int     |
| PersonId    | int     |
| City        | varchar |
| State       | varchar |
+-------------+---------+
AddressId is the primary key column for this table.
\end{Code}

Write a SQL query for a report that provides the following information for each person in the Person table, regardless if there is an address for each of those people:

\subsubsection{outer join}
\begin{Code}
  // Note: Using where clause to filter the records will fail if there is
  // no address information for a person because it will not display the name information.
SELECT
    FirstName, LastName, City, State
FROM
    Person LEFT JOIN Address
ON
    Person.PersonID = Address.PersonID
;
\end{Code}

\section{Second Highest Salary} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:second-highest-salary}


\subsubsection{描述}
SQL Schema

Table: Employee
\begin{Code}
+----+--------+
| Id | Salary |
+----+--------+
| 1  | 100    |
| 2  | 200    |
| 3  | 300    |
+----+--------+
\end{Code}

For example, given the above Employee table, the query should return 200 as the second highest salary. If there is no second highest salary, then the query should return null.
\begin{Code}
+---------------------+
| SecondHighestSalary |
+---------------------+
| 200                 |
+---------------------+
\end{Code}

Write a SQL query to get the second highest salary from the Employee table.

\subsubsection{sub-query and LIMIT clause}
\begin{Code}
  // Note: Use a sub-query to handle only one record in this table
SELECT
    (SELECT DISTINCT
        Salary
     FROM
         Employee
     ORDER BY Salary DESC
     LIMIT 1 OFFSET 1) AS SecondHighestSalary
;
\end{Code}

\subsubsection{IFNULL and LIMIT}
\begin{Code}
  // Note: Use a sub-query to handle only one record in this table
SELECT
    IFNULL(
      (SELECT DISTINCT
           Salary
       FROM
           Employee
       ORDER BY Salary DESC
       LIMIT 1 OFFSET 1),
    NULL) AS SecondHighestSalary
;
\end{Code}

\section{Nth Highest Salary} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:nth-highest-salary}


\subsubsection{描述}
SQL Schema

Table: Employee
\begin{Code}
+----+--------+
| Id | Salary |
+----+--------+
| 1  | 100    |
| 2  | 200    |
| 3  | 300    |
+----+--------+
\end{Code}

For example, given the above Employee table, the nth highest salary where n = 2 is 200. If there is no nth highest salary, then the query should return null.
\begin{Code}
+------------------------+
| getNthHighestSalary(2) |
+------------------------+
| 200                    |
+------------------------+
\end{Code}

Write a SQL query to get the nth highest salary from the Employee table.

\subsubsection{IFNULL and LIMIT}
\begin{Code}
CREATE FUNCTION getNthHighestSalary(N INT) RETURNS INT
BEGIN

SET N=N-1;
  RETURN (
      # Write your MySQL query statement below.
      select
          ifnull(
              (select distinct
                   salary
               from
                   employee
               order by  salary desc
               limit N,1),
          null)
  );
END
\end{Code}

\section{Rank Scores} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:rank-scores}


\subsubsection{描述}
SQL Schema

\begin{Code}
Create table If Not Exists Scores (Id int, Score DECIMAL(3,2))
Truncate table Scores
insert into Scores (Id, Score) values ('1', '3.5')
insert into Scores (Id, Score) values ('2', '3.65')
insert into Scores (Id, Score) values ('3', '4.0')
insert into Scores (Id, Score) values ('4', '3.85')
insert into Scores (Id, Score) values ('5', '4.0')
insert into Scores (Id, Score) values ('6', '3.65')
\end{Code}

Write a SQL query to rank scores. If there is a tie between two scores, both should have the same ranking. Note that after a tie, the next ranking number should be the next consecutive integer value. In other words, there should be no "holes" between ranks.

Table: Scores
\begin{Code}
+----+-------+
| Id | Score |
+----+-------+
| 1  | 3.50  |
| 2  | 3.65  |
| 3  | 4.00  |
| 4  | 3.85  |
| 5  | 4.00  |
| 6  | 3.65  |
+----+-------+
\end{Code}

For example, given the above Scores table, your query should generate the following report (order by highest score):
\begin{Code}
+-------+---------+
| score | Rank    |
+-------+---------+
| 4.00  | 1       |
| 4.00  | 1       |
| 3.85  | 2       |
| 3.65  | 3       |
| 3.65  | 3       |
| 3.50  | 4       |
+-------+---------+
\end{Code}

\textbf{Important Note}: For MySQL solutions, to escape reserved words used as column names, you can use an apostrophe before and after the keyword. For example `Rank`.

\subsubsection{Dense_Rank}
\begin{Code}
SELECT Score, dense_rank() OVER(ORDER BY Score DESC) AS `Rank` FROM Scores;
\end{Code}

\section{Consecutive Numbers} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:consecutive-numbers}


\subsubsection{描述}
SQL Schema

\begin{Code}
Create table If Not Exists Logs (Id int, Num int)
Truncate table Logs
insert into Logs (Id, Num) values ('1', '1')
insert into Logs (Id, Num) values ('2', '1')
insert into Logs (Id, Num) values ('3', '1')
insert into Logs (Id, Num) values ('4', '2')
insert into Logs (Id, Num) values ('5', '1')
insert into Logs (Id, Num) values ('6', '2')
insert into Logs (Id, Num) values ('7', '2')
\end{Code}

Write an SQL query to find all numbers that appear at least three times consecutively.
Return the result table in any order.
The query result format is in the following example:

Table: Logs
\begin{Code}
+-------------+---------+
| Column Name | Type    |
+-------------+---------+
| id          | int     |
| num         | varchar |
+-------------+---------+
id is the primary key for this table.
\end{Code}


\begin{Code}
Logs table:
+----+-----+
| Id | Num |
+----+-----+
| 1  | 1   |
| 2  | 1   |
| 3  | 1   |
| 4  | 2   |
| 5  | 1   |
| 6  | 2   |
| 7  | 2   |
+----+-----+

Result table:
+-----------------+
| ConsecutiveNums |
+-----------------+
| 1               |
+-----------------+
1 is the only number that appears consecutively for at least three times.
\end{Code}


\subsubsection{multiple table}
\begin{Code}
SELECT DISTINCT
    l1.Num AS ConsecutiveNums
FROM
    Logs l1,
    Logs l2,
    Logs l3
WHERE
    l1.Id = l2.Id - 1
    AND l2.Id = l3.Id - 1
    AND l1.Num = l2.Num
    AND l2.Num = l3.Num
;
\end{Code}

\section{Employees Earning More Than Their Managers} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:employees-earning-more-than-their-managers}


\subsubsection{描述}
SQL Schema

\begin{Code}
Create table If Not Exists Employee (Id int, Name varchar(255), Salary int, ManagerId int)
Truncate table Employee
insert into Employee (Id, Name, Salary, ManagerId) values ('1', 'Joe', '70000', '3')
insert into Employee (Id, Name, Salary, ManagerId) values ('2', 'Henry', '80000', '4')
insert into Employee (Id, Name, Salary, ManagerId) values ('3', 'Sam', '60000', 'None')
insert into Employee (Id, Name, Salary, ManagerId) values ('4', 'Max', '90000', 'None')
\end{Code}

The Employee table holds all employees including their managers. Every employee has an Id, and there is also a column for the manager Id.

Table: Employee
\begin{Code}
+----+-------+--------+-----------+
| Id | Name  | Salary | ManagerId |
+----+-------+--------+-----------+
| 1  | Joe   | 70000  | 3         |
| 2  | Henry | 80000  | 4         |
| 3  | Sam   | 60000  | NULL      |
| 4  | Max   | 90000  | NULL      |
+----+-------+--------+-----------+
\end{Code}

Given the Employee table, write a SQL query that finds out employees who earn more than their managers. For the above table, Joe is the only employee who earns more than his manager.

\begin{Code}
+----------+
| Employee |
+----------+
| Joe      |
+----------+
\end{Code}


\subsubsection{multiple table}
\begin{Code}
SELECT
    a.Name AS 'Employee'
FROM
    Employee AS a,
    Employee AS b
WHERE
    a.ManagerId = b.Id
        AND a.Salary > b.Salary
;
\end{Code}

\subsubsection{join}
\begin{Code}
SELECT
     a.NAME AS Employee
FROM Employee AS a JOIN Employee AS b
     ON a.ManagerId = b.Id
     AND a.Salary > b.Salary
;
\end{Code}
